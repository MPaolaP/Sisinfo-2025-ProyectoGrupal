{% extends 'layout_usuarios.html' %}
{% block title %}Inventario | Distrito 5{% endblock %}

{% block content %}
<div class="inventory-container" id="inventory_module">
    <div class="inventory-header">
        <div class="header-info">
            <h2>Gestión de <span class="highlight">Inventario</span></h2>
            <p class="inventory-subtitle">Control de existencias, clasificaciones y transferencias entre sucursales.</p>
        </div>
        <div id="inventory_feedback" class="inventory-feedback" role="alert" aria-live="polite"></div>
    </div>

    <div class="inventory-summary" id="inventory_summary">
        <div class="summary-card" data-summary="units">
            <div class="summary-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="summary-info">
                <span class="summary-label">Unidades totales</span>
                <span class="summary-value">0</span>
            </div>
        </div>
        <div class="summary-card" data-summary="items">
            <div class="summary-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="summary-info">
                <span class="summary-label">Referencias controladas</span>
                <span class="summary-value">0</span>
            </div>
        </div>
        <div class="summary-card" data-summary="low_stock">
            <div class="summary-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="summary-info">
                <span class="summary-label">Stock en alerta</span>
                <span class="summary-value">0</span>
            </div>
        </div>
        <div class="summary-card" data-summary="transfers">
            <div class="summary-icon">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="summary-info">
                <span class="summary-label">Transferencias pendientes</span>
                <span class="summary-value">0</span>
            </div>
        </div>
    </div>

    <div class="inventory-panels">
        <section class="inventory-panel inventory-filters" aria-labelledby="filters_title">
            <div class="panel-header">
                <h3 id="filters_title">Clasificación de productos</h3>
                <p>Filtra el inventario por talla, color, categoría y sucursal.</p>
            </div>
            <div class="filter-grid">
                <div class="filter-field">
                    <label for="size_filter">Talla</label>
                    <select id="size_filter">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label for="color_filter">Color</label>
                    <select id="color_filter">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label for="category_filter">Categoría</label>
                    <select id="category_filter">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label for="store_filter">Sucursal</label>
                    <select id="store_filter">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-field search-field">
                    <label for="inventory_search">Buscar</label>
                    <input type="search" id="inventory_search" placeholder="Nombre, SKU o ubicación" autocomplete="off">
                </div>
            </div>
        </section>

        <section class="inventory-panel inventory-alerts" aria-labelledby="alerts_title">
            <div class="panel-header">
                <h3 id="alerts_title">Alertas de stock mínimo</h3>
                <p>Monitoreo del stock mínimo configurado para cada producto.</p>
            </div>
            <div id="inventory_alerts_list" class="alerts-scrollable">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Cargando alertas...</div>
            </div>
        </section>
    </div>

    <section class="inventory-panel inventory-table" aria-labelledby="table_title">
        <div class="panel-header">
            <div class="panel-title">
                <h3 id="table_title">Existencias por sucursal</h3>
                <p>Detalle de entradas, salidas y stock actual por producto.</p>
            </div>
            {% if current_user.user_type == 1 %}
            <button type="button" class="btn-secondary" id="open_product_modal">Gestionar productos</button>
            {% endif %}
        </div>
        <div class="table-wrapper fixed-table-wrapper">
            <div class="table-scroll-container" role="region" aria-live="polite" aria-label="Existencias por sucursal">
                <table id="inventory_table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>SKU</th>
                            <th>Talla</th>
                        <th>Color</th>
                        <th>Categoría</th>
                        <th>Sucursal</th>
                        <th>Stock</th>
                        <th>Mínimo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" class="table-empty">Cargando inventario...</td>
                    </tr>
                </tbody>
                </table>
            </div>
        </div>
    </section>

    {% if current_user.user_type in [1, 2] %}
    <section class="inventory-panel movement-management" aria-labelledby="movements_title">
        <div class="panel-header">
            <h3 id="movements_title">Entradas y salidas</h3>
            <p>Registra movimientos manuales de inventario por sucursal.</p>
        </div>
        <div class="movement-grid">
            <form id="movement_form" class="movement-form">
                <div class="form-field form-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="new_product_toggle" name="new_product_toggle" value="1">
                        Registrar producto nuevo
                    </label>
                </div>
                <div class="form-field" data-existing-product-field>
                    <label for="movement_product_search">Buscar producto</label>
                    <input type="search" id="movement_product_search" placeholder="Nombre o SKU" autocomplete="off">
                </div>
                <div class="form-field" data-existing-product-field>
                    <label for="movement_product">Producto</label>
                    <select id="movement_product" name="movement_product">
                        <option value="">Seleccione un producto</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="movement_store">Sucursal</label>
                    <select id="movement_store" required>
                        <option value="">Seleccione una sucursal</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="movement_type">Tipo de movimiento</label>
                    <select id="movement_type" required>
                        <option value="entry">Entrada</option>
                        <option value="exit">Salida</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="movement_quantity">Cantidad</label>
                    <input type="number" id="movement_quantity" min="1" required>
                </div>
                <div id="movement_product_details" class="product-details-card" hidden>
                    <h5>Detalle del producto</h5>
                    <div class="details-grid">
                        <div>
                            <span class="detail-label">SKU</span>
                            <span class="detail-value" data-detail="sku">—</span>
                        </div>
                        <div>
                            <span class="detail-label">Categoría</span>
                            <span class="detail-value" data-detail="category">—</span>
                        </div>
                        <div>
                            <span class="detail-label">Talla</span>
                            <span class="detail-value" data-detail="size">—</span>
                        </div>
                        <div>
                            <span class="detail-label">Color</span>
                            <span class="detail-value" data-detail="color">—</span>
                        </div>
                        <div>
                            <span class="detail-label">Stock actual</span>
                            <span class="detail-value" data-detail="stock">—</span>
                        </div>
                        <div>
                            <span class="detail-label">Mínimo</span>
                            <span class="detail-value" data-detail="min_stock">—</span>
                        </div>
                    </div>
                </div>
                <div id="new_product_fields" class="new-product-fields" hidden>
                    <h4>Nuevo producto</h4>
                    <div class="form-field">
                        <label for="new_product_name">Nombre del producto</label>
                        <input type="text" id="new_product_name" name="new_product_name" autocomplete="off">
                    </div>
                    <div class="form-field">
                        <label for="new_product_sku">Código/SKU</label>
                        <input type="text" id="new_product_sku" name="new_product_sku" autocomplete="off">
                    </div>
                    <div class="form-field">
                        <label for="new_product_category">Categoría</label>
                        <input type="text" id="new_product_category" name="new_product_category" list="inventory_category_options" autocomplete="off">
                    </div>
                    <div class="form-field">
                        <label for="new_product_size">Talla</label>
                        <input type="text" id="new_product_size" name="new_product_size" list="inventory_size_options" autocomplete="off">
                    </div>
                    <div class="form-field">
                        <label for="new_product_color">Color</label>
                        <input type="text" id="new_product_color" name="new_product_color" list="inventory_color_options" autocomplete="off">
                    </div>
                    <div class="form-field">
                        <label for="new_product_min_stock">Stock mínimo</label>
                        <input type="number" id="new_product_min_stock" name="new_product_min_stock" min="0">
                    </div>
                    <div class="form-field">
                        <label for="new_product_price">Precio (opcional)</label>
                        <input type="number" id="new_product_price" name="new_product_price" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-field full-width">
                    <label for="movement_notes">Observaciones</label>
                    <textarea id="movement_notes" rows="2" placeholder="Motivo del movimiento"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Registrar movimiento</button>
                </div>
            </form>
            <div class="movement-history" aria-live="polite">
                <h4>Movimientos recientes</h4>
                <div id="movements_list" class="movements-scrollable">
                    <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Cargando movimientos...</div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <datalist id="inventory_category_options"></datalist>
    <datalist id="inventory_size_options"></datalist>
    <datalist id="inventory_color_options"></datalist>

    <section class="inventory-panel transfer-management" aria-labelledby="transfers_title">
        <div class="panel-header">
            <h3 id="transfers_title">Transferencias entre sucursales</h3>
            {% if current_user.user_type == 3 %}
            <p>Solicita el envío de productos a otra sucursal para reponer stock.</p>
            {% else %}
            <p>Gestiona solicitudes, aprobaciones y confirmaciones de traslado.</p>
            {% endif %}
        </div>
        <div class="transfer-grid">
            <form id="transfer_form" class="transfer-form">
                <h4>{% if current_user.user_type == 3 %}Nueva solicitud de transferencia{% else %}Registrar transferencia{% endif %}</h4>
                <div class="form-field">
                    <label for="transfer_product">Producto</label>
                    <select id="transfer_product" required>
                        <option value="">Seleccione un producto</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="transfer_source">Sucursal origen</label>
                    <select id="transfer_source" required>
                        <option value="">Seleccione origen</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="transfer_target">Sucursal destino</label>
                    <select id="transfer_target" required>
                        <option value="">Seleccione destino</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="transfer_quantity">Cantidad</label>
                    <input type="number" id="transfer_quantity" min="1" required>
                </div>
                <div class="form-field full-width">
                    <label for="transfer_notes">Observaciones</label>
                    <textarea id="transfer_notes" rows="2" placeholder="Detalles de la solicitud"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Enviar solicitud</button>
                </div>
            </form>
            <div class="transfer-history" aria-live="polite">
                <h4>Seguimiento de transferencias</h4>
                <div id="transfers_list" class="transfers-scrollable">
                    <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Cargando transferencias...</div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.USER_TYPE = Number('{{ current_user.user_type | default(0) }}');
</script>
<script src="{{ url_for('static', filename='js/inventory_module.js') }}"></script>
{% if current_user.user_type == 1 %}
<div class="modal" id="product_edit_modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="product_modal_title">
    <div class="modal-backdrop" data-modal-action="close"></div>
    <div class="modal-content">
        <header class="modal-header">
            <h3 id="product_modal_title">Editar producto</h3>
            <button type="button" class="modal-close" data-modal-action="close" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <form id="product_edit_form" class="modal-form">
            <div class="form-field">
                <label for="product_edit_select">Producto</label>
                <select id="product_edit_select" required>
                    <option value="">Seleccione un producto</option>
                </select>
            </div>
            <div class="form-field">
                <label for="product_edit_sku">Código/SKU</label>
                <input type="text" id="product_edit_sku" required>
            </div>
            <div class="form-field">
                <label for="product_edit_name">Nombre del producto</label>
                <input type="text" id="product_edit_name" required>
            </div>
            <div class="form-field">
                <label for="product_edit_min_stock">Stock mínimo</label>
                <input type="number" id="product_edit_min_stock" min="0" required>
            </div>
            <div class="form-field">
                <label for="product_edit_size">Talla</label>
                <input type="text" id="product_edit_size" list="inventory_size_options">
            </div>
            <div class="form-field">
                <label for="product_edit_color">Color</label>
                <input type="text" id="product_edit_color" list="inventory_color_options">
            </div>
            <div class="form-field">
                <label for="product_edit_category">Categoría</label>
                <input type="text" id="product_edit_category" list="inventory_category_options">
            </div>
            <div class="form-field">
                <label for="product_edit_price">Precio (opcional)</label>
                <input type="number" id="product_edit_price" min="0" step="0.01">
            </div>
            <footer class="modal-actions">
                <button type="button" class="btn-secondary" data-modal-action="close">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar cambios</button>
            </footer>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
